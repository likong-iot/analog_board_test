# ESP32Shell 组件

一个功能完整的ESP32命令行Shell组件，支持多实例、宏录制、键值存储和实时任务管理。

## 🚀 功能特性

- **多实例支持**: 支持创建多个独立的Shell实例
- **I/O抽象**: 协议无关的I/O接口，支持UART、RS485等
- **宏录制**: 支持录制和执行命令宏
- **键值存储**: 每个实例独立的键值对存储
- **实时任务管理**: 显示系统状态、任务信息、内存使用等
- **连续命令解析**: 支持多命令连续执行
- **模块化设计**: 命令按功能分类，易于扩展

## 🏗️ 程序架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ESP32Shell 组件架构                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   Shell实例1    │    │   Shell实例2    │    │   Shell实例N    │        │
│  │  (Channel ID 0) │    │  (Channel ID 1) │    │ (Channel ID N)  │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│           │                       │                       │                │
│           └───────────────────────┼───────────────────────┘                │
│                                   │                                        │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐  │
│  │                    Shell 核心管理模块                                │  │
│  └─────────────────────────────────┼─────────────────────────────────────┘  │
│                                   │                                        │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐  │
│  │                    命令执行引擎                                    │  │
│  └─────────────────────────────────┼─────────────────────────────────────┘  │
│                                   │                                        │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐  │
│  │                    I/O 抽象层                                      │  │
│  └─────────────────────────────────┼─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 详细数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ESP32Shell 详细数据流架构                                              │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│  外部输入 (UART/RS485)                                                                                  │
│         │                                                                                               │
│         ▼                                                                                               │
│  ┌─────────────────┐                                                                                    │
│  │  main_add_data  │ ──→ shell_add_data_to_instance() ──→ cmd_add_data()                              │
│  │    函数指针     │                                                                                    │
│  └─────────────────┘                                                                                    │
│         │                                                                                               │
│         ▼                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Shell 实例 (shell_instance_t)                                          │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │ │
│  │  │   cmd_buffer    │  │   cmd_queue     │  │   kv_store      │  │  macro_buffer   │                │ │
│  │  │   (原始输入)    │  │   (解析命令)    │  │   (键值存储)    │  │   (宏录制)      │                │ │
│  │  │                 │  │                 │  │                 │  │                 │                │ │
│  │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │                │ │
│  │  │ │   buffer    │ │  │ │   head      │ │  │ │   head      │ │  │ │   head      │ │                │ │
│  │  │ │   head      │ │  │ │   tail      │ │  │ │   count     │ │  │ │   count     │ │                │ │
│  │  │ │   tail      │ │  │ │   count     │ │  │ │   mutex     │ │  │ │ recording   │ │                │ │
│  │  │ │   count     │ │  │ │   mutex     │ │  │ │             │ │  │ │ temp_queue  │ │                │ │
│  │  │ │   mutex     │ │  │ │             │ │  │ │             │ │  │ │ mutex       │ │                │ │
│  │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │                │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                                               │
│         ▼                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              双任务架构                                                              │ │
│  │                                                                                                     │ │
│  │  ┌─────────────────────────────────┐                    ┌─────────────────────────────────┐        │ │
│  │  │        Parser Task              │                    │       Executor Task             │        │ │
│  │  │   (shell_parser_task)           │                    │   (shell_executor_task)         │        │ │
│  │  │                                 │                    │                                 │        │ │
│  │  │  cmd_get_all_commands()         │ ──→ cmd_queue ──→ │  cmd_queue_dequeue()            │        │ │
│  │  │  cmd_queue_enqueue()            │                    │  cmd_execute()                  │        │ │
│  │  │                                 │                    │                                 │        │ │
│  │  └─────────────────────────────────┘                    └─────────────────────────────────┘        │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                                               │
│         ▼                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              命令执行引擎                                                           │ │
│  │                                                                                                     │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │ │
│  │  │   宏命令处理    │  │   内置命令处理  │  │   键值存储处理  │  │   系统命令处理  │                │ │
│  │  │                 │  │                 │  │                 │  │                 │                │ │
│  │  │ macro           │  │ help            │  │ kv set/get/del  │  │ tasks           │                │ │
│  │  │ endmacro        │  │ echo            │  │ kv list/clear   │  │ heap            │                │ │
│  │  │ exec macro      │  │ version         │  │ kv count        │  │ cpu             │                │ │
│  │  │ exec <name>     │  │ clear           │  │                 │  │ uptime          │                │ │
│  │  │                 │  │ test            │  │                 │  │ reset            │                │ │
│  │  │                 │  │ buffer          │  │                 │  │ delay            │                │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                                               │
│         ▼                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              I/O 输出层                                                             │ │
│  │                                                                                                     │ │
│  │  ┌─────────────────┐                                                                                │ │
│  │  │  cmd_output()   │ ──→ main_output_func() ──→ rs485_tx() ──→ UART发送                            │ │
│  │  │    函数指针     │                                                                                │ │
│  │  └─────────────────┘                                                                                │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 核心数据结构关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    核心数据结构关系                                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│  shell_instance_t (Shell实例)                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                                                     │ │
│  │  shell_config_t config                    ┌─────────────────────────────────────────────────────┐   │ │
│  │  ├─ channel_id: uint32_t                  │                    cmd_buffer_t                      │   │ │
│  │  ├─ channel_name: char*                   │  ┌─────────────────────────────────────────────────┐ │   │ │
│  │  ├─ prompt: char*                         │  │  uint8_t buffer[CMD_BUFFER_SIZE]               │ │   │ │
│  │  └─ output_func: shell_output_func_t      │  │  size_t head                                    │ │   │ │
│  │                                           │  │  size_t tail                                    │ │   │ │
│  │  cmd_buffer_t cmd_buffer                  │  │  size_t count                                   │ │   │ │
│  │  ├─ buffer[CMD_BUFFER_SIZE]               │  │  SemaphoreHandle_t mutex                       │ │   │ │
│  │  ├─ head, tail, count                     │  └─────────────────────────────────────────────────┘ │   │ │
│  │  └─ mutex                                 │                                                       │ │
│  │                                           │  ┌─────────────────────────────────────────────────┐ │   │ │
│  │  cmd_queue_t cmd_queue                    │  │                    cmd_queue_t                 │ │   │ │
│  │  ├─ head: cmd_queue_item_t*               │  │  cmd_queue_item_t *head                        │ │   │ │
│  │  ├─ tail: cmd_queue_item_t*               │  │  cmd_queue_item_t *tail                        │ │   │ │
│  │  ├─ count: size_t                         │  │  size_t count                                   │ │   │ │
│  │  └─ mutex                                 │  │  SemaphoreHandle_t mutex                       │ │   │ │
│  │                                           │  └─────────────────────────────────────────────────┘ │   │ │
│  │  kv_store_t kv_store                      │                                                       │ │
│  │  ├─ head: kv_pair_t*                      │  ┌─────────────────────────────────────────────────┐ │   │ │
│  │  ├─ count: size_t                         │  │                    kv_store_t                   │ │   │ │
│  │  └─ mutex                                 │  │  kv_pair_t *head                                │ │   │ │
│  │                                           │  │  size_t count                                   │ │   │ │
│  │  macro_buffer_t macro_buffer              │  │  SemaphoreHandle_t mutex                       │ │   │ │
│  │  ├─ head: macro_item_t*                   │  └─────────────────────────────────────────────────┘ │   │ │
│  │  ├─ count: size_t                         │                                                       │ │
│  │  ├─ recording: bool                       │  ┌─────────────────────────────────────────────────┐ │   │ │
│  │  ├─ current_macro_name[64]                │  │                  macro_buffer_t                 │ │   │ │
│  │  ├─ temp_queue: cmd_queue_t               │  │  macro_item_t *head                             │ │   │ │
│  │  └─ mutex                                 │  │  size_t count                                    │ │   │ │
│  │                                           │  │  bool recording                                  │ │   │ │
│  │  TaskHandle_t parser_task_handle          │  │  char current_macro_name[64]                    │ │   │ │
│  │  TaskHandle_t executor_task_handle        │  │  cmd_queue_t temp_queue                         │ │   │ │
│  │  bool initialized                         │  │  SemaphoreHandle_t mutex                        │ │   │ │
│  │                                           │  └─────────────────────────────────────────────────┘ │   │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    链表结构                                                          │ │
│  │                                                                                                     │ │
│  │  cmd_queue_item_t                    kv_pair_t                    macro_item_t                     │ │
│  │  ┌─────────────────┐                ┌─────────────────┐          ┌─────────────────┐              │ │
│  │  │ char command[]  │                │ char key[64]    │          │ char name[64]   │              │ │
│  │  │ cmd_queue_item  │                │ uint32_t value  │          │ cmd_queue_t     │              │ │
│  │  │ *next           │                │ kv_pair_t *next │          │ queue           │              │ │
│  │  └─────────────────┘                └─────────────────┘          │ macro_item_t    │              │ │
│  │                                                                   │ *next           │              │ │
│  │                                                                   └─────────────────┘              │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 命令执行流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    命令执行流程                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│  1. 输入阶段                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │  UART接收   │───▶│ main_add_   │───▶│ shell_add_  │───▶│ cmd_add_    │                        │
│     │             │    │ data_func   │    │ data_to_    │    │ data       │                        │
│     │             │    │             │    │ instance    │    │            │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  2. 解析阶段                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ Parser Task │───▶│ cmd_get_all │───▶│ cmd_queue_  │───▶│ 命令队列    │                        │
│     │             │    │ _commands   │    │ enqueue     │    │ (cmd_queue) │                        │
│     │             │    │             │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  3. 执行阶段                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ Executor    │───▶│ cmd_queue_  │───▶│ cmd_execute │───▶│ 命令分发    │                        │
│     │ Task        │    │ dequeue     │    │             │    │             │                        │
│     │             │    │             │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  4. 命令处理                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ 宏命令      │    │ 内置命令    │    │ 键值存储    │    │ 系统命令    │                        │
│     │             │    │             │    │             │    │             │                        │
│     │ macro       │    │ help        │    │ kv set      │    │ tasks       │                        │
│     │ endmacro    │    │ echo        │    │ kv get      │    │ heap        │                        │
│     │ exec        │    │ version     │    │ kv del      │    │ cpu         │                        │
│     │             │    │ clear       │    │ kv list     │    │ uptime      │                        │
│     │             │    │ test        │    │ kv clear    │    │ reset       │                        │
│     │             │    │ buffer      │    │ kv count    │    │ delay       │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  5. 输出阶段                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ cmd_output  │───▶│ main_output │───▶│ rs485_tx    │───▶│ UART发送    │                        │
│     │             │    │ _func       │    │             │    │             │                        │
│     │             │    │             │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 宏录制流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    宏录制流程                                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│  1. 开始录制                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ macro <name>│───▶│ macro_buffer│───▶│ 检查名称    │───▶│ 设置录制    │                        │
│     │             │    │ _start_     │    │ 唯一性      │    │ 状态        │                        │
│     │             │    │ recording   │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  2. 命令录制                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ 用户输入    │───▶│ cmd_execute │───▶│ 检查录制    │───▶│ macro_buffer│                        │
│     │ 命令        │    │             │    │ 状态        │    │ _add_       │                        │
│     │             │    │             │    │             │    │ command     │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  3. 停止录制                                                                                            │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ endmacro    │───▶│ macro_buffer│───▶│ 创建宏项    │───▶│ 添加到宏    │                        │
│     │             │    │ _stop_      │    │ (macro_item)│    │ 列表        │                        │
│     │             │    │ recording   │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
│  4. 宏执行                                                                                              │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│     │ exec <name> │───▶│ macro_buffer│───▶│ 查找宏      │───▶│ 执行宏中    │                        │
│     │             │    │ _execute_   │    │ 名称        │    │ 所有命令    │                        │
│     │             │    │ _by_name    │    │             │    │             │                        │
│     └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                        │
│                                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

### 1. 组件集成

```cmake
# main/CMakeLists.txt
idf_component_register(
    SRCS "main.c" "485.c"
    INCLUDE_DIRS "."
    REQUIRES esp32shell
)
```

### 2. 基本使用

```c
#include "shell.h"
#include "485.h"

void main_output_func(uint32_t channel_id, const uint8_t *data, size_t length) {
    rs485_tx(UART_NUM_1, data, length);
}

void app_main(void) {
    rs485_init();
    shell_system_init();
    
    shell_config_t config = create_shell_config(
        0, "UART1", "UART1> ", main_output_func
    );
    
    shell_instance_t *shell = shell_create_and_start(&config);
    xTaskCreate(task_rs485_rx, "rs485_rx", 4096, NULL, 5, NULL);
}
```

## 📋 内置命令

### 基础命令
- `help` - 显示帮助信息
- `echo <text>` - 回显参数
- `version` - 显示版本信息
- `clear` - 清屏
- `test <params>` - 参数测试

### 键值存储功能详解
键值存储系统提供了完整的键值对管理功能：

**基本操作**:
- `kv set <key> <value>` - 设置键值对
- `kv get <key>` - 获取键值
- `kv del <key>` - 删除键值对

**高级操作**:
- `kv copy <src> <dst>` - 复制键值对（新功能）
  - 将源键的值复制给目标键
  - 如果目标键不存在则创建，存在则覆盖
- `kv list` - 格式化显示所有键值对（改进功能）
  - 以表格形式显示，包含序号、键名、值
  - 自动对齐，便于阅读

**管理操作**:
- `kv clear` - 清空所有键值对
- `kv count` - 显示键值对数量

**使用示例**:
```
kv set temperature 25
kv set humidity 60
kv copy temperature temp_backup
kv list
```

### 键值存储命令
- `kv set <key> <value>` - 设置键值对
- `kv get <key>` - 获取键值
- `kv copy <src> <dst>` - 复制键值对
- `kv del <key>` - 删除键值对
- `kv list` - 列出所有键值对（格式化表格显示）
- `kv clear` - 清空所有键值对
- `kv count` - 显示键值对数量

### 宏管理命令
- `macro <name>` - 开始录制宏
- `endmacro` - 停止录制宏
- `exec macro` - 执行第一个宏
- `exec <name>` - 执行指定宏

### 缓冲区管理命令
- `buffer` - 显示宏缓冲区信息
- `buffer list` - 显示所有宏详细信息
- `buffer show <name>` - 显示指定宏内容
- `buffer clear` - 清空所有宏
- `buffer exec [name]` - 执行宏
- `buffer del <name>` - 删除指定宏

### 系统命令
- `tasks` - 显示任务信息
- `heap` - 显示内存信息
- `cpu` - 显示CPU状态
- `uptime` - 显示运行时间
- `reset` - 系统重启
- `delay <ms>` - 延时测试

## 🔧 配置选项

### FreeRTOS配置
```ini
CONFIG_FREERTOS_USE_TRACE_FACILITY=y
CONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=y
CONFIG_FREERTOS_GENERATE_RUN_TIME_STATS=y
CONFIG_FREERTOS_RUN_TIME_COUNTER_TYPE_U32=y
CONFIG_FREERTOS_RUN_TIME_STATS_USING_ESP_TIMER=y
```

### 缓冲区大小配置
```c
#define CMD_BUFFER_SIZE 1024    // 命令缓冲区大小
#define MAX_CMD_LENGTH 256      // 最大命令长度
#define MAX_TASKS 32            // 最大任务数量
```

## 📄 许可证

本项目采用 MIT 许可证。

---

**ESP32Shell** - 为ESP32提供强大的命令行Shell功能
